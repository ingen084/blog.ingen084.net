---
title: "光クロスで快適自宅サーバー環境構築 ISP選び編"
category: "雑記"
tags: ["ネットワーク", "光クロス"]
date: 2022-08-11 00:00:00 +09:00

permalink: /posts/20220811-hikari-cross-network1
---

僕の部屋では自宅サーバーを運営していたのですが、この度めでたく上り下り最大10Gbpsの光クロス+固定IPv4で自宅サーバー環境を構築しましたのでいろいろ書いてみたいと思います。  
ちなみに、**現在使用しているISPの紹介はしません。** 通常の手段では契約できなかったからです。

**自宅側のルーターなどの設備の話は次の記事に書きます**。  
ちなみに今回構築するまでほぼネットワークに関する知識がありませんでした。

## 経緯

1Gbpsって帯域少なくないですか！？  
(うそです、↓120M↑12MのCATV回線から光回線に変えたときは感動しました・・・。)

今現在自宅には4TBのHDD5台+予備1台で構築したZFSのNASが存在するのですが、ファイルへのアクセスだけで1Gbpsを使い果たしてしまうことがありLANの増強を検討していました。(2020年ぐらいの話)  
昨今資本力がある回線事業者(nuro,eo光など)が1Gbpsを超えた回線速度を出すことができるサービスを提供しており検討していたのですが、以下の理由からフレッツ光(OCN)を使い続けていました。

> - nuroやeo光ではISPを変更することができないため、業者変更のコストが高い
> - フレッツでは複数のPPPoEセッションを使用することで固定IP+変動IPを併用できる
>     - 固定IPとしてインターリンクのZOOT NEXTを使用していました
> - フレッツでは追加でMAP-Eなどを併用することで普段使いの回線としてPPPoEを回避することができる

そんなところ2020年中に光クロスのサービスが開始され2022年初頭に住居地域でも申し込みが可能になったため申し込んだ次第です。

## 既存環境からの移動コストについて

現状の光クロスにはフレッツ光に比べて以下の制約(違い)があります。

> - IPv6のアドレスの取得にRAが利用できない、DHCPv6が必要
> - ひかり電話の契約有無にかかわらず、プレフィクスの割当が /56 になる
>   - ちなみに現状ひかり電話の契約はできない
> - PPPoE は使用不可で IPv4 の環境は IPoE + IPv4 over IPv6 で構築が必要
>   - 大抵のISPでは IPv4 over IPv6 では IPv4 アドレスが共有され、ポート開放ができないもしくは制限される
>   - ただ送られてきた紙にはセッション2つって書いてあったので接続しようとしたらできるのかもしれない

自宅サーバーを運営する上で一番の障害となるのはPPPoEが使えなくなることで、ポート開放ができなくなることを危惧していました。  
そこで今までなんとなく使っていた IPv4 over IPv6 について調べてみることにしました。

PPPoE では基本1セッションにつきフルで使用できるIPアドレスが固定して割り当てられていましたが、**IPv4 over IPv6 で固定IPがほしければ明示的にそういったオプションを提供しているISPと契約する必要があります**。

ちなみになぜこの方式が利用されることになったのかや PPPoE が抱える課題などについては割愛します。

## IPv4 over IPv6 について

あんまり詳しくないので間違えてたら指摘いただけると嬉しいです。

日本の固定回線では主に MAP-E と DS-Lite が使用されていて、 v6プラス など商標名がついているところが多いです。  
提供方法については主に2種類存在し、

> - ISP側がゲートウェイを提供している
> - VNEが提供しているサービスを再販している

というパターンが多いです。

ここで出てくるVNEですが、これは簡単に説明すると フレッツの契約と紐付きNGN網(フレッツの回線網)内でグローバルIPv6アドレスを割り振り、インターネットへの経路を設置している業者 です。  
IPoEと呼ばれているもので、VNEの紐づけが行われていない場合、NGN網でのローカルIPが割り当てられ網内での折り返し通信しかできなくなります。 

IPv4 over IPv6 のゲートウェイ自体は IPv6 に IPv4 のパケットをカプセル化しているだけですので誰でも建てることができるという認識ですが、大抵は VNE 業者側でセットで提供されており、大抵のISPはそれを再販しています。  
大規模なISPでは自社でVNE及び IPv4 over IPv6 を提供しているパターンも多いです(ビッグローブやOCNなど)。そのISPが別のISPに同じ商標を使用して再販しているケースもありました。

再販を行っている有名なVNE業者は以下の通りです(独断と偏見で選んでいます)

<TableContainer>
  <Table variant='simple'>
    <Thead>
      <Tr>
        <Th>商標</Th>
        <Th>運営会社</Th>
        <Th>方式</Th>
        <Th>再販業者(一例)</Th>
      </Tr>
    </Thead>
    <Tbody>
      <Tr>
        <Td>v6プラス</Td>
        <Td>JPNE(KDDI)</Td>
        <Td>MAP-E</Td>
        <Td>enひかり</Td>
      </Tr>
      <Tr>
        <Td>Xpass</Td>
        <Td>アルテリア・ネットワークス</Td>
        <Td>DS-Lite/IPIP(固定IP)</Td>
        <Td>びわこインターネット</Td>
      </Tr>
      <Tr>
        <Td>transix</Td>
        <Td>INTERNET MULTIFEED</Td>
        <Td>DS-Lite/IPIP(固定IP)</Td>
        <Td>ZOOT NATIVE</Td>
      </Tr>
    </Tbody>
  </Table>
</TableContainer>

再販業者が明示的に再販元を提示していない場合でも解説ページへのリンクの設置や商標を使用しているケースがあり、ある程度特定することができます。

## MAP-E と DS-Lite の方式の違いについて

大きな違いは**IPアドレスの変換をどこで行うか**、にあります。

DS-Lite は ISP(VNE) 側、 MAP-E はユーザーのルーター側で行います。つまり、

> - DS-Lite はルーター側に**自身が使用できるIPアドレス･ポートの情報が必要ない**が、外部ポート･アドレスが関知しない範囲で指定されるため、**ポート開放ができない**
> - MAP-E はルーター側に**自身が使用できるIPアドレス･ポートの情報が必要**だが、使用できるポート範囲が決められており、その範囲内であればポート開放ができる

ということです。  
MAP-E のIPアドレスやポート範囲については割り当てられたIPv6アドレスのプレフィクスから計算することができ、市販ルーターなどではこの計算ロジックから使用できるIPアドレス･ポート情報を使用して接続しています。  
IPv6プレフィクスは半固定のため、実質IPv4アドレスは変わらないということになりますね。

ちなみに、 IPIP は固定IPアドレスをもらいルーター側でIPアドレスの変換を直接行うため、制限のない MAP-E というか、 MAP-E が範囲に制限のある IPIP というだけです。

## 光クロス対応のISPでも気をつけたいこと

これらの情報からISPを選ぶところまではできますが、1点気をつけることがあります。  
**光クロス対応でも帯域制御がかかっており1Gbpsしか出ないISPが存在する**ことです。  
特に transix ではユーザーの帯域制御が公式にオプションとして存在しているため注意する必要があります。

少なくとも僕は無料体験期間中に気づけて助かりましたが、2022年6月時点では ZOOT NATIVE は 1Gbps で制限されているようでしたので注意してください。

現状僕はv6プラスの固定IPを再販しているISPと契約しています。

## おわり

疲れた…  
次回はこれらのISPと接続する機器たちの話をしたいと思います。

[次回の記事はこちら](20220926-hikari-cross-network2)
